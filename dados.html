<!DOCTYPE html>
<html lang="pt-br">
   <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <meta name="description" content="Pagina de consulta de notas">
      <meta name="author" content="Julio Cesar">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
      <title>NF-e Coco do Vale</title>
      <style>
         html, body {
         margin: 0;
         padding: 0;
         height: 100%;
         font-family: Arial, sans-serif;
         background-color: #f4f4f4;
         overflow: hidden;
         }
         #tabelaDados {
         font-size: 8px;
         text-align: center; /* diminui para 8 pixels, pode ajustar para o tamanho que quiser */
         }
         .container {
         display: flex;
         height: 100vh;         
         }
         .sidebar {
         width: 5%;
         background-color: #0288d1;
         color: white;
         padding: 10px;
         box-sizing: border-box;
         }
         .sidebar h3 {
         font-size: 12px;
         margin-top: 0;
         }
         .content {
         flex: 1;
         padding: 10px;
         display: flex;
         flex-direction: column;
         overflow: hidden;
         width: 95%;
         height: 98vh;
         }
         .filter-group {
         display: flex;
         gap: 10px;
         flex-wrap: wrap;
         margin-bottom: 10px;
         align-items: center;
         }
         .filter-group label {
         font-size: 12px;
         }
         .filter-group input[type="text"],
         .filter-group input[type="date"] {
         font-size: 12px;
         padding: 2px 4px;
         height: 20px;
         }
         .filter-group button {
         font-size: 12px;
         padding: 4px 8px;
         cursor: pointer;
         }
         .table-wrapper {
         flex: 1;
         overflow-y: auto;
         border: 1px solid #ccc;
         background: white;
         }
         table {
         width: 100%;
         border-collapse: collapse;
         font-size: 12px;
         }
         thead {
         position: sticky;
         top: 0;
         background: #e0e0e0;
         z-index: 1;
         }
         th, td {
         padding: 4px 6px;
         border: 1px solid #ccc;
         text-align: left;
         }
         td, tr {
         max-width: 200px;
         overflow: hidden;
         text-overflow: ellipsis;
         white-space: nowrap;
         }
         table tbody tr td:nth-child(13) {
         text-align: right;
         }
         .right-align {
         text-align: right;
         }
         .center-align {
         text-align: center;
         }
         #total-container {
         font-size: 12px;
         background: #fff;
         padding: 10px;
         border-top: 1px solid #ccc;
         position: sticky;
         bottom: 0;
         z-index: 10;
         }
         .input-pequeno {
         width: 80px; /* ajuste conforme necess√°rio */
         font-size: 14px; /* opcional, para diminuir o texto */
         padding: 4px;    /* opcional, para controlar o espa√ßo interno */
         }
         .input-grande {
         width: 250px;     /* aumenta a largura */
         font-size: 18px;  /* aumenta o texto */
         padding: 8px;     /* aumenta o espa√ßamento interno */
         }
      </style>
   </head>
   <body>
      <div class="container">
         <div class="sidebar">
            <h3>Coco do Vale</h3>
            <ul style="list-style: none; padding-left: 0; font-size: 12px;">
               <li>NF-e</li>
               <br />
               <li><a href="cargas-fabrica.html" style="color: white; text-decoration: none;">Cargas Fabrica</a></li>
            </ul>
         </div>
         <div class="content">
            <h2>Notas Fiscais</h2>
            <div class="filter-group">
               <!-- Filtros originais de Emiss√£o, NF e UF -->
               <label>Emiss√£o de: <input type="date" id="startDate" /></label>
               <label>At√©: <input type="date" id="endDate" /></label>
               <input type="text" class="input-pequeno" id="notaFilter" placeholder="NF" />
               <input type="text" class="input-pequeno" id="ufFilter" placeholder="UF" />
               <input type="text" class="input-grande" id="razaoSocialFilter" placeholder="Raz√£o Social" />               
               <!-- NOVO filtro por data de Previs√£o -->
               <label>Previs√£o de: <input type="date" id="startPrev" /></label>
               <label>At√©: <input type="date" id="endPrev" /></label>
               <!-- Bot√µes -->
               <button onclick="filterData()">Pesquisar</button>
               <button onclick="clearFilters()">Limpar</button>
               <button onclick="exportarTabelaParaExcel()">üì§ Exp.Excel</button>
            </div>
            <div class="table-wrapper">
               <table id="minhaTabela">
                  <thead>
                     <tr>
                        <th>A√ß√µes</th>
                        <th>Nota</th>
                        <th>DT Emiss√£o</th>
                        <th>Dt Sa√≠da</th>
                        <th>Dt Chegada</th>
                        <th>Previs√£o/Agenda</th>
                        <th>Ocorr√™ncia da Nota</th>
                        <th>C√≥d.Cliente</th>
                        <th>Raz√£o Social</th>
                        <th>Bairro</th>
                        <th>Cidade</th>
                        <th>UF</th>
                        <th>Val. Brut</th>
                     </tr>
                  </thead>
                  <tbody id="tabelaNotas"></tbody>
               </table>
            </div>
            <div id="total-container">
               <strong>Total de Notas:</strong> <span id="totalNotas">0</span> |
               <strong>Valor Bruto Total:</strong> R$ <span id="totalValor">0,00</span><br>
               <!-- Aqui ficar√° o total filtrado apenas pela DT Previs√£o -->
               <strong>Total por Previs√£o:</strong> R$ <span id="totalPrev">0,00</span><br>
               <div class="footer-text mt-3">
                  <em>Desenvolvido por Julio Cesar</em>
               </div>
            </div>
         </div>
      </div>
      <script>
         let dados = [];
         
         // 1) Carrega o CSV do Google Sheets e converte em array de objetos
         async function carregarDados() {
         const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRrclG6V0hZ6mUJAP5J5zwZPi4Qfw-NJjjk0apARx1Kk-KROKenmVdHx4yZW3reeC23sp7ChUZOZKhy/pub?output=csv';
         
         try {
         const resposta = await fetch(url);
         const texto = await resposta.text();
         
         const resultado = Papa.parse(texto, {
         header: true,
         skipEmptyLines: true,
         });
         
         dados = resultado.data;
         
         // ordena pela nota
         dados.sort((a, b) => parseInt(a['Nota'] || '0', 10) - parseInt(b['Nota'] || '0', 10));
         
         exibirDados(dados);
         } catch (e) {
         console.error(e);
         document.getElementById('tabelaNotas').innerHTML =
         `<tr><td colspan="14" class="center-align" style="color:red;">Erro ao carregar os dados.</td></tr>`;
         }
         }         
         
         // 2) Limpa strings de Valor Bruto (ex.: "17.329,52" ou " 17 329,52 ") ‚Üí n√∫mero 17329.52
         function limparValorNumerico(val) {
           if (!val) return 0;
         
           // 2.1) Remove tudo que N√ÉO seja d√≠gito (0-9) ou v√≠rgula
           //      Exemplo: "17.329,52" ‚Üí "17329,52"; " 17 329,52 " (com NBSP) ‚Üí "17329,52"
           let somenteDigitosEVirgula = String(val).replace(/[^\d,]/g, '');
         
           // 2.2) Substitui todas as v√≠rgulas por ponto (para parseFloat)
           //      Exemplo: "17329,52" ‚Üí "17329.52"
           let convertido = somenteDigitosEVirgula.replace(/,/g, '.');
         
           let num = parseFloat(convertido);
           return isNaN(num) ? 0 : num;
         }
         
         // 3) Formata n√∫mero em real pt-BR (ex.: 17329.52 ‚Üí "17.329,52")
         function formatarNumeroBR(numero) {
           return numero.toLocaleString('pt-BR', {
             minimumFractionDigits: 2,
             maximumFractionDigits: 2
           });
         }
         
         // 4) Exibe a lista de objetos (notas) na tabela e calcula Valor Bruto Total
         function exibirDados(lista) {
           const tabela = document.getElementById('tabelaNotas');
           tabela.innerHTML = '';
         
           // Se nenhum registro bateu nos filtros, mostra mensagem:
           if (lista.length === 0) {
             tabela.innerHTML =
               `<tr><td colspan="14" class="center-align">Nenhum resultado encontrado para os filtros.</td></tr>`;
             atualizarTotal(0, 0);
             return;
           }
         
           let somaValor = 0;
         
           lista.forEach(item => {
             // 4.1) Extrai o valor bruto (como n√∫mero) usando a limpeza acima
             const valorBruto = limparValorNumerico(item['Val. Brut']);
             somaValor += valorBruto;
         
             // 4.2) Monta cada <tr> com:
             //      1¬™ coluna: bot√£o ‚ÄúVer‚Äù (A√ß√µes)
             //      Demais colunas: campos conforme cabe√ßalho
             const tr = document.createElement('tr');
         
             // Cria a c√©lula do bot√£o
             const tdBotao = document.createElement('td');
             const botao = document.createElement('button');
             botao.textContent = 'Ver';
             botao.addEventListener('click', () => {
               alert(
                 'Nota: ' + (item['Nota'] || '') + '\n' +
                 'DT Emiss√£o: ' + (item['DT Emiss√£o'] || '') + '\n' +
                 'DT Sa√≠da: ' + (item['DT Sa√≠da'] || '') + '\n' +
                 'Dt Previs√£o: ' + (item['DT Previs√£o'] || '') + '\n' +
                 'Ocorr√™ncia: ' + (item['Ocorr√™ncia da Nota'] || '') + '\n' +
                 'Raz√£o Social: ' + (item['Raz√£o Social'] || '') + '\n' +            
                 'Cidade: ' + (item['Cidade'] || '') + '\n' +
                 'UF: ' + (item['UF'] || '') + '\n' +
                 'Val. Brut: ' + (item['Val. Brut'] || '')
               );
             });
             tdBotao.appendChild(botao);
             tr.appendChild(tdBotao);
         
             // Adiciona as outras colunas
             [
               'Nota', 'DT Emiss√£o', 'DT Sa√≠da', 'Dt Chegada','DT Previs√£o', 'Ocorr√™ncia da Nota', 'Cod.Cliente', 'Raz√£o Social',
               'Bairro', 'Cidade', 'UF'
             ].forEach(coluna => {
               const td = document.createElement('td');
               td.textContent = item[coluna] || '';
               tr.appendChild(td);
             });
         
             // √öltima coluna: valor formatado
             const tdValor = document.createElement('td');
             tdValor.textContent = formatarNumeroBR(valorBruto);
             tr.appendChild(tdValor);
         
             // Adiciona a linha √† tabela
             document.getElementById('tabelaNotas').appendChild(tr);
         
           });
         
           // 4.3) Atualiza o rodap√© com total de registros e soma dos valores
           atualizarTotal(lista.length, somaValor);
         }
         
         // 5) Atualiza ‚ÄúTotal de Notas‚Äù e ‚ÄúValor Bruto Total‚Äù
         function atualizarTotal(totalNotas, totalValor) {
           document.getElementById('totalNotas').textContent = totalNotas;
           document.getElementById('totalValor').textContent = formatarNumeroBR(totalValor);
         }
         
         // 6) Filtra por Emiss√£o, NF, UF e PREVIS√ÉO; calcula soma apenas para intervalo de Previs√£o
         function filterData() {
          const nota        = document.getElementById('notaFilter').value.trim();
          const uf          = document.getElementById('ufFilter').value.trim().toUpperCase();
          const start       = document.getElementById('startDate').value;    // Dt Emiss√£o in√≠cio (YYYY-MM-DD)
          const end         = document.getElementById('endDate').value;      // Dt Emiss√£o fim   (YYYY-MM-DD)
          const startPrev   = document.getElementById('startPrev').value;    // Dt Previs√£o in√≠cio
          const endPrev     = document.getElementById('endPrev').value;      // Dt Previs√£o fim
          const razaoSocialFilter = document.getElementById('razaoSocialFilter').value.trim().toLowerCase();
         
          let somaPrev = 0;
         
          const filtrado = dados.filter(item => {
            // Converte DT Emiss√£o de dd/mm/aaaa para aaaa-mm-dd
            let dtEmissaoISO = '';
            if (item['DT Emiss√£o']) {
              const partes = item['DT Emiss√£o'].split('/');
              if (partes.length === 3) {
                dtEmissaoISO = `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
              }
            }
         
            // Converte DT Previs√£o de dd/mm/aaaa para aaaa-mm-dd
            let dtPrevISO = '';
            if (item['DT Previs√£o']) {
              const partesPrev = item['DT Previs√£o'].split('/');
              if (partesPrev.length === 3) {
                dtPrevISO = `${partesPrev[2]}-${partesPrev[1].padStart(2, '0')}-${partesPrev[0].padStart(2, '0')}`;
              }
            }
         
            // Flags iniciais
            let emissaoValida  = true;
            let previsaoValida = true;
         
            // Filtros de data de emiss√£o
            if (start) emissaoValida = emissaoValida && (dtEmissaoISO >= start);
            if (end)   emissaoValida = emissaoValida && (dtEmissaoISO <= end);
         
            // Filtros de data de previs√£o
            if (startPrev) previsaoValida = previsaoValida && (dtPrevISO >= startPrev);
            if (endPrev)   previsaoValida = previsaoValida && (dtPrevISO <= endPrev);
         
            // Filtros por nota, UF e raz√£o social
            const notaValida  = !nota || item['Nota'] === nota;
            const ufValida    = !uf   || item['UF'] === uf;
            const razaoValida = !razaoSocialFilter || 
              (item['Raz√£o Social'] && item['Raz√£o Social'].toLowerCase().includes(razaoSocialFilter));
         
            const todosValidos = emissaoValida && previsaoValida && notaValida && ufValida && razaoValida;
         
            // Soma valor bruto se passar por todos os filtros e estiver no intervalo de previs√£o
            if (todosValidos && startPrev && endPrev && dtPrevISO >= startPrev && dtPrevISO <= endPrev) {
              somaPrev += limparValorNumerico(item['Val. Brut']);
            }
         
            return todosValidos;
          });
         
          // Atualiza total da previs√£o
          document.getElementById('totalPrev').textContent = formatarNumeroBR(somaPrev);
         
         // 6.6) Exibe as linhas filtradas
         exibirDados(filtrado);
         }
         
         // 7) Limpa todos os filtros e retorna a tabela completa
         function clearFilters() {
          document.getElementById('startDate').value = '';
          document.getElementById('endDate').value = '';
          document.getElementById('notaFilter').value = '';
          document.getElementById('ufFilter').value = '';
          document.getElementById('razaoSocialFilter').value = ''; // ‚úÖ esta linha faltava
          document.getElementById('startPrev').value = '';
          document.getElementById('endPrev').value = '';
          document.getElementById('totalPrev').textContent = '0,00';
          exibirDados(dados);
         }
         
         // 8) Exporta a tabela (filtrada ou n√£o) para um arquivo Excel
         
         document.addEventListener("DOMContentLoaded", () => {
         carregarDados();
         });
         
         function exportarTabelaParaExcel() {
         try {
         const tabela = document.getElementById("minhaTabela");
         if (!tabela) {
         alert("Tabela n√£o encontrada!");
         return;
         }
         
         const wb = XLSX.utils.book_new();
         const ws_data = [];
         
         const dateCols = [2, 3, 4, 5];  // Colunas de data (√≠ndices zero-based)
         const numberCols = [12];       // Coluna de valor num√©rico (ex: coluna 13 visualmente)
         
         const linhas = tabela.querySelectorAll("tr");
         linhas.forEach(linha => {
         const row = [];
         linha.querySelectorAll("th, td").forEach((coluna, index) => {
         const valor = coluna.textContent.trim();
         
         // Se for data no formato dd/mm/yyyy
         if (dateCols.includes(index) && /^\d{2}\/\d{2}\/\d{4}$/.test(valor)) {
          const [dd, mm, aaaa] = valor.split("/");
          row.push(new Date(`${aaaa}-${mm}-${dd}`));
         }
         // Se for n√∫mero no padr√£o pt-BR (1.234,56)
         else if (numberCols.includes(index) && /^\d{1,3}(?:\.\d{3})*,\d{2}$/.test(valor)) {
          const numero = parseFloat(valor.replace(/\./g, "").replace(",", "."));
          row.push(isNaN(numero) ? valor : numero);
         }
         else {
          row.push(valor); // mant√©m texto exatamente como est√°
         }
         });
         ws_data.push(row);
         });
         
         const ws = XLSX.utils.aoa_to_sheet(ws_data);
         
         // Corrige tipo das c√©lulas de data e n√∫mero
         const range = XLSX.utils.decode_range(ws["!ref"]);
         for (let R = range.s.r + 1; R <= range.e.r; ++R) {
         for (let C = range.s.c; C <= range.e.c; ++C) {
         const ref = XLSX.utils.encode_cell({ r: R, c: C });
         const cell = ws[ref];
         if (!cell) continue;
         
         if (dateCols.includes(C) && cell.v instanceof Date) {
          cell.t = "d";
          cell.z = "dd/mm/yyyy";
         }
         else if (numberCols.includes(C) && typeof cell.v === "number") {
          cell.t = "n";
          cell.z = "#,##0.00";
         }
         }
         }
         
         XLSX.utils.book_append_sheet(wb, ws, "Notas Fiscais");
         XLSX.writeFile(wb, "Notas_Fiscais.xlsx");
         } catch (erro) {
         console.error("Erro na exporta√ß√£o:", erro);
         alert("Erro ao exportar a planilha. Veja o console para detalhes.");
         }
         }
         
      </script>
   </body>
</html>