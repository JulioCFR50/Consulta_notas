<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- As bibliotecas seguem iguais ao seu original -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <title>Consulta Notas Fiscais</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      overflow: hidden;
    }

    #tabelaDados {
    font-size: 8px;
    text-align: center; /* diminui para 8 pixels, pode ajustar para o tamanho que quiser */
  }
    .container {
      display: flex;
      height: 100vh;
      
    }
    .sidebar {
      width: 5%;
      background-color: #0288d1;
      color: white;
      padding: 10px;
      box-sizing: border-box;
    }
    .sidebar h3 {
      font-size: 12px;
      margin-top: 0;
    }
    .content {
      flex: 1;
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .filter-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      align-items: center;
    }
    .filter-group label {
      font-size: 12px;
    }
    .filter-group input[type="text"],
    .filter-group input[type="date"] {
      font-size: 12px;
      padding: 2px 4px;
      height: 24px;
    }
    .filter-group button {
      font-size: 12px;
      padding: 4px 8px;
      cursor: pointer;
    }
    .table-wrapper {
      flex: 1;
      overflow-y: auto;
      border: 1px solid #ccc;
      background: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead {
      position: sticky;
      top: 0;
      background: #e0e0e0;
      z-index: 1;
    }
    th, td {
      padding: 4px 6px;
      border: 1px solid #ccc;
      text-align: left;
    }

    td, tr {
      max-width: 200px;         /* define largura m√°xima da coluna */
      overflow: hidden;         /* esconde o excesso */
      text-overflow: ellipsis;  /* adiciona '...' quando o texto for cortado */
      white-space: nowrap;      /* evita quebra de linha */
    }

    .right-align {
      text-align: right;
    }
    .center-align {
      text-align: center;
    }
    #total-container {
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="sidebar">
      <h3>Coco do Vale</h3>
      <ul style="list-style: none; padding-left: 0; font-size: 12px;">
        <li>NF-e</li><br>
        <li>Cargas Fabrica</li>
      </ul>
    </div>
    <div class="content">
      <h2>Notas Fiscais</h2>
      <div class="filter-group">
        <!-- Filtros originais de Emiss√£o, NF e UF -->
        <label>Emiss√£o de: <input type="date" id="startDate" /></label>
        <label>At√©: <input type="date" id="endDate" /></label>
        <input type="text" id="notaFilter" placeholder="NF" />
        <input type="text" id="ufFilter" placeholder="UF" />

        <!-- NOVO filtro por data de Previs√£o -->
        <label>Previs√£o de: <input type="date" id="startPrev" /></label>
        <label>At√©: <input type="date" id="endPrev" /></label>

        <!-- Bot√µes -->
        <button onclick="filterData()">Pesquisar</button>
        <button onclick="clearFilters()">Limpar</button>
        <button onclick="exportarTabelaParaExcel()">üì§ Exportar para Excel</button>
      </div>

      <div class="table-wrapper">
        <!-- A tabela, com cabe√ßalho incluindo ‚ÄúA√ß√µes‚Äù -->
        <table id="minhaTabela">
          <thead>
            <tr>
              <th>A√ß√µes</th>
              <th>Nota</th>
              <th>DT Emiss√£o</th>
              <th>Dt Sa√≠da</th>
              <th>Dt Chegada</th>
              <th>Previs√£o/Agenda</th>
              <th>Ocorr√™ncia da Nota</th>
              <th>C√≥d.Cliente</th>
              <th>Raz√£o Social</th>
              <th>Bairro</th>
              <th>Cidade</th>
              <th>UF</th>
              <th>Val. Brut</th>
            </tr>
          </thead>
          <tbody id="tabelaNotas"></tbody>
        </table>
      </div>

      <div id="total-container">
        <strong>Total de Notas:</strong> <span id="totalNotas">0</span> |
        <strong>Valor Bruto Total:</strong> R$ <span id="totalValor">0,00</span><br>
        <!-- Aqui ficar√° o total filtrado apenas pela DT Previs√£o -->
        <strong>Total por Previs√£o:</strong> R$ <span id="totalPrev">0,00</span><br>
      <div class="footer-text mt-3">
      <Strong>Desenvolvido por</Strong><em> Julio Cesar </em>
      </div>
      </div>
    </div>
  </div>

  <script>
    let dados = [];

    // 1) Carrega o CSV do Google Sheets e converte em array de objetos
    async function carregarDados() {
      const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRrclG6V0hZ6mUJAP5J5zwZPi4Qfw-NJjjk0apARx1Kk-KROKenmVdHx4yZW3reeC23sp7ChUZOZKhy/pub?output=csv';
      try {
        const resposta = await fetch(url);
        if (!resposta.ok) throw new Error('Erro ao carregar dados.');
        const texto = await resposta.text();

        // Divide em linhas e ignora vazias
        const linhas = texto.split('\n').filter(linha => linha.trim() !== '');
        if (linhas.length === 0) return;

        // O cabe√ßalho (primeira linha) serve de ‚Äúchave‚Äù para cada coluna
        const cabecalhos = linhas[0].split(',');

        dados = linhas.slice(1).map(linha => {
          const colunas = linha.split(',');
          return cabecalhos.reduce((obj, cab, i) => {
            obj[cab.trim()] = colunas[i]?.trim() || '';
            return obj;
          }, {});
        });

        // 1.1) Ordena pelo n√∫mero da Nota (campo ‚ÄúNota‚Äù)
        dados.sort((a, b) => {
          const na = parseInt(a['Nota'] || '0', 10);
          const nb = parseInt(b['Nota'] || '0', 10);
          return na - nb;
        });

        // Exibe tudo logo que o site carrega
        exibirDados(dados);
      } catch (e) {
        console.error(e);
        document.getElementById('tabelaNotas').innerHTML =
          `<tr><td colspan="14" class="center-align" style="color:red;">Erro ao carregar os dados.</td></tr>`;
      }
    }

    // 2) Limpa strings de Valor Bruto (ex.: "17.329,52" ou " 17 329,52 ") ‚Üí n√∫mero 17329.52
    function limparValorNumerico(val) {
      if (!val) return 0;

      // 2.1) Remove tudo que N√ÉO seja d√≠gito (0-9) ou v√≠rgula
      //      Exemplo: "17.329,52" ‚Üí "17329,52"; " 17 329,52 " (com NBSP) ‚Üí "17329,52"
      let somenteDigitosEVirgula = String(val).replace(/[^\d,]/g, '');

      // 2.2) Substitui todas as v√≠rgulas por ponto (para parseFloat)
      //      Exemplo: "17329,52" ‚Üí "17329.52"
      let convertido = somenteDigitosEVirgula.replace(/,/g, '.');

      let num = parseFloat(convertido);
      return isNaN(num) ? 0 : num;
    }

    // 3) Formata n√∫mero em real pt-BR (ex.: 17329.52 ‚Üí "17.329,52")
    function formatarNumeroBR(numero) {
      return numero.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    // 4) Exibe a lista de objetos (notas) na tabela e calcula Valor Bruto Total
    function exibirDados(lista) {
      const tabela = document.getElementById('tabelaNotas');
      tabela.innerHTML = '';

      // Se nenhum registro bateu nos filtros, mostra mensagem:
      if (lista.length === 0) {
        tabela.innerHTML =
          `<tr><td colspan="14" class="center-align">Nenhum resultado encontrado para os filtros.</td></tr>`;
        atualizarTotal(0, 0);
        return;
      }

      let somaValor = 0;

      lista.forEach(item => {
        // 4.1) Extrai o valor bruto (como n√∫mero) usando a limpeza acima
        const valorBruto = limparValorNumerico(item['Val. Brut']);
        somaValor += valorBruto;

        // 4.2) Monta cada <tr> com:
        //      1¬™ coluna: bot√£o ‚ÄúVer‚Äù (A√ß√µes)
        //      Demais colunas: campos conforme cabe√ßalho
        const tr = document.createElement('tr');

        // Cria a c√©lula do bot√£o
        const tdBotao = document.createElement('td');
        const botao = document.createElement('button');
        botao.textContent = 'Ver';
        botao.addEventListener('click', () => {
          alert(
            'Nota: ' + (item['Nota'] || '') + '\n' +
            'DT Emiss√£o: ' + (item['DT Emiss√£o'] || '') + '\n' +
            'DT Sa√≠da: ' + (item['DT Sa√≠da'] || '') + '\n' +
            'Dt Previs√£o: ' + (item['DT Previs√£o'] || '') + '\n' +
            'Ocorr√™ncia: ' + (item['Ocorr√™ncia da Nota'] || '') + '\n' +
            'Raz√£o Social: ' + (item['Raz√£o Social'] || '') + '\n' +            
            'Cidade: ' + (item['Cidade'] || '') + '\n' +
            'UF: ' + (item['UF'] || '') + '\n' +
            'Val. Brut: ' + (item['Val. Brut'] || '')
          );
        });
        tdBotao.appendChild(botao);
        tr.appendChild(tdBotao);

        // Adiciona as outras colunas
        [
          'Nota', 'DT Emiss√£o', 'DT Sa√≠da', 'Dt Chegada','DT Previs√£o', 'Ocorr√™ncia da Nota', 'Cod.Cliente', 'Raz√£o Social',
          'Bairro', 'Cidade', 'UF'
        ].forEach(coluna => {
          const td = document.createElement('td');
          td.textContent = item[coluna] || '';
          tr.appendChild(td);
        });

        // √öltima coluna: valor formatado
        const tdValor = document.createElement('td');
        tdValor.textContent = formatarNumeroBR(valorBruto);
        tr.appendChild(tdValor);

        // Adiciona a linha √† tabela
        document.getElementById('tabelaNotas').appendChild(tr);

      });

      // 4.3) Atualiza o rodap√© com total de registros e soma dos valores
      atualizarTotal(lista.length, somaValor);
    }

    // 5) Atualiza ‚ÄúTotal de Notas‚Äù e ‚ÄúValor Bruto Total‚Äù
    function atualizarTotal(totalNotas, totalValor) {
      document.getElementById('totalNotas').textContent = totalNotas;
      document.getElementById('totalValor').textContent = formatarNumeroBR(totalValor);
    }

    // 6) Filtra por Emiss√£o, NF, UF e PREVIS√ÉO; calcula soma apenas para intervalo de Previs√£o
    function filterData() {
      const nota = document.getElementById('notaFilter').value.trim();
      const uf   = document.getElementById('ufFilter').value.trim().toUpperCase();
      const start     = document.getElementById('startDate').value;    // Dt Emiss√£o in√≠cio (YYYY-MM-DD)
      const end       = document.getElementById('endDate').value;      // Dt Emiss√£o fim   (YYYY-MM-DD)
      const startPrev = document.getElementById('startPrev').value;    // Dt Previs√£o in√≠cio
      const endPrev   = document.getElementById('endPrev').value;      // Dt Previs√£o fim

      let somaPrev = 0;
      const filtrado = dados.filter(item => {
        // 6.1) Converte ‚ÄúDT Emiss√£o‚Äù de dd/mm/aaaa ‚Üí aaaa-mm-dd
        let dtEmissaoISO = '';
        if (item['DT Emiss√£o']) {
          const p = item['DT Emiss√£o'].split('/');
          if (p.length === 3) {
            dtEmissaoISO = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
          }
        }

        // 6.2) Converte ‚ÄúDT Previs√£o‚Äù de dd/mm/aaaa ‚Üí aaaa-mm-dd
        let dtPrevISO = '';
        if (item['DT Previs√£o']) {
          const pp = item['DT Previs√£o'].split('/');
          if (pp.length === 3) {
            dtPrevISO = `${pp[2]}-${pp[1].padStart(2,'0')}-${pp[0].padStart(2,'0')}`;
          }
        }

        // 6.3) Inicializa flags como true
        let emissaoValida  = true;
        let previsaoValida = true;

        // Filtro de data de emiss√£o
        if (start)      emissaoValida  = emissaoValida  && (dtEmissaoISO >= start);
        if (end)        emissaoValida  = emissaoValida  && (dtEmissaoISO <= end);

        // Filtro de data de previs√£o
        if (startPrev)  previsaoValida = previsaoValida && (dtPrevISO >= startPrev);
        if (endPrev)    previsaoValida = previsaoValida && (dtPrevISO <= endPrev);

        // Filtros adicionais: NF e UF
        const notaValida = !nota || item['Nota'] === nota;
        const ufValida   = !uf   || item['UF']   === uf;

        const todosValidos = emissaoValida && previsaoValida && notaValida && ufValida;

        // 6.4) Se passar em todos os filtros e estiver no intervalo de PREVIS√ÉO,
        //      acumula o ‚ÄúVal. Brut‚Äù para o ‚ÄúTotal por Previs√£o‚Äù
        if (todosValidos && startPrev && endPrev &&
            dtPrevISO >= startPrev && dtPrevISO <= endPrev) {
          somaPrev += limparValorNumerico(item['Val. Brut']);
        }

        return todosValidos;
      });

      // 6.5) Exibe o total filtrado pela Previs√£o
      document.getElementById('totalPrev').textContent = formatarNumeroBR(somaPrev);

      // 6.6) Exibe as linhas filtradas
      exibirDados(filtrado);
    }

    // 7) Limpa todos os filtros e retorna a tabela completa
    function clearFilters() {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value   = '';
      document.getElementById('notaFilter').value = '';
      document.getElementById('ufFilter').value   = '';
      document.getElementById('startPrev').value  = '';
      document.getElementById('endPrev').value    = '';
      document.getElementById('totalPrev').textContent = '0,00';
      exibirDados(dados);
    }

    // 8) Exporta a tabela (filtrada ou n√£o) para um arquivo Excel
    function exportarTabelaParaExcel() {
      const tabela = document.getElementById("minhaTabela");
      if (!tabela) {
        alert("Tabela n√£o encontrada!");
        return;
      }
      const workbook = XLSX.utils.table_to_book(tabela, { sheet: "Notas Fiscais" });
      XLSX.writeFile(workbook, "Notas_Fiscais.xlsx");
    }

    // 9) Quando a p√°gina carrega, busca os dados e exibe tudo
    window.onload = carregarDados;
  </script>
</body>
</html>
